description: >
  Accuknox IAC Scan
parameters:
  FILE:
    description: 'Specify a file for scanning; cannot be used with directory input. Filter runners by file type, e.g., ".tf" for Terraform.'
    default: ""
    type: string
  DIRECTORY:
    description: 'Directory with infrastructure code and/or package manager files to scan'
    default: "."
    type: string
  COMPACT:
    description: "Do not display code blocks in output"
    default: true
    type: boolean
  QUIET:
    description: "Display only failed checks"
    default: true
    type: boolean
  SOFT_FAIL:
    description: "Do not return an error code if there are failed checks"
    default: true
    type: boolean
  FRAMEWORK:
    description: "Run only on a specific infrastructure, Supported: Kubernetes & Terraform"
    default: ""
    type: string
steps:
  - run:
      name: Run AccuKnox ASPM Scanner
      environment:
        FILE: <<parameters.FILE>>
        DIRECTORY: <<parameters.DIRECTORY>>
        COMPACT: <<parameters.COMPACT>>
        QUIET: <<parameters.QUIET>>
        SOFT_FAIL: <<parameters.SOFT_FAIL>>
        FRAMEWORK: <<parameters.FRAMEWORK>>
      command: |
        echo "Installing AccuKnox ASPM scanner..."
        pip install https://github.com/accuknox/aspm-scanner-cli/releases/download/v0.13.4/accuknox_aspm_scanner-0.13.4-py3-none-any.whl --break-system-packages

        echo "Running AccuKnox iac scan"
        if [ "$SOFT_FAIL" = "1" ]; then
          SOFT_FAIL_ARG="--softfail"
        fi

        CMD_ARGS=""
        [ -n "$FILE" ] && CMD_ARGS="$CMD_ARGS --file $FILE"
        [ -n "$DIRECTORY" ] && CMD_ARGS="$CMD_ARGS --directory $DIRECTORY"
        [ "$COMPACT" = "1" ] && CMD_ARGS="$CMD_ARGS --compact"
        [ "$QUIET" = "1" ] && CMD_ARGS="$CMD_ARGS --quiet"
        [ -n "$FRAMEWORK" ] && CMD_ARGS="$CMD_ARGS --framework $FRAMEWORK"

        if [ -n "$CIRCLE_REPOSITORY_URL" ]; then
          REPOSITORY_URL_ARG="--repo-url $CIRCLE_REPOSITORY_URL"
        fi

        echo accuknox-aspm-scanner scan $SOFT_FAIL_ARG iac --command "$CMD_ARGS" --container-mode $REPOSITORY_URL_ARG --repo-branch $CIRCLE_BRANCH
        accuknox-aspm-scanner scan $SOFT_FAIL_ARG iac --command "$CMD_ARGS" --container-mode $REPOSITORY_URL_ARG --repo-branch $CIRCLE_BRANCH
