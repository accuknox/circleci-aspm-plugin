description: >
  Accuknox SAST Scan
parameters:
  SOFT_FAIL:
    description: "Do not return an error code if there are failed checks"
    default: true
    type: boolean
  PIPELINE_ID:
    description: "Job ID"
    default: ""
    type: string
  JOB_URL:
    description: "The URL for the current job"
    default: ""
    type: string
steps:
  - run:
      name: Run AccuKnox ASPM Scanner
      environment:
        SOFT_FAIL: <<parameters.SOFT_FAIL>>
      command: |
        echo "Installing AccuKnox ASPM scanner..."
        pip install https://github.com/accuknox/aspm-scanner-cli/releases/download/v0.13.4/accuknox_aspm_scanner-0.13.4-py3-none-any.whl --break-system-packages

        if [ "$SOFT_FAIL" = "true" ]; then
          SOFT_FAIL_ARG="--softfail"
        fi

        echo "Running SAST scan..."
        accuknox-aspm-scanner tool install --type sast
        accuknox-aspm-scanner scan $SOFT_FAIL_ARG sast --command "scan ."