description: >
  AccuKnox DAST Scan
parameters:
  TARGET_URL:
    description: "The URL of the web application to scan."
    type: string
  DAST_SCAN_SCRIPT:
    description: "ZAP scan script to use (e.g., zap-baseline.py)"
    default: "zap-baseline.py"
    type: string
  SEVERITY_THRESHOLD:
    description: "Minimum severity to fail the pipeline (LOW, MEDIUM, HIGH). Default is HIGH."
    default: "HIGH"
    type: string
  DAST_SCAN_TYPE:
    description: "DAST scan type: baseline or full-scan"
    default: "baseline"
    type: string
  SOFT_FAIL:
    description: "Do not return an error code if there are failed checks"
    default: true
    type: boolean
steps:
  - run:
      name: Run AccuKnox ASPM Scanner
      environment:
        TARGET_URL: <<parameters.TARGET_URL>>
        DAST_SCAN_SCRIPT: <<parameters.DAST_SCAN_SCRIPT>>
        SEVERITY_THRESHOLD: <<parameters.SEVERITY_THRESHOLD>>
        DAST_SCAN_TYPE: <<parameters.DAST_SCAN_TYPE>>
        SOFT_FAIL: <<parameters.SOFT_FAIL>>
      command: |
        echo "Installing AccuKnox ASPM scanner..."
        pip install https://github.com/accuknox/aspm-scanner-cli/releases/download/v0.13.4/accuknox_aspm_scanner-0.13.4-py3-none-any.whl --break-system-packages

        echo "Running AccuKnox dast scan"
        mkdir /tmp/scan-dir
        chmod 777 /tmp/scan-dir
        cd /tmp/scan-dir

        if [ "$SOFT_FAIL" = "true" ]; then
          SOFT_FAIL_ARG="--softfail"
        fi 
  
        ARGS="$DAST_SCAN_SCRIPT -t $TARGET_URL -I "
        [ -n "$SEVERITY_THRESHOLD" ] && ARGS="$ARGS --severity-threshold \"$SEVERITY_THRESHOLD\""
        [ -n "$DAST_SCAN_TYPE" ] && ARGS="$ARGS --dast-scan-type \"$DAST_SCAN_TYPE\""
        
        echo accuknox-aspm-scanner scan $SOFT_FAIL_ARG dast --command "$ARGS" --container-mode
        accuknox-aspm-scanner scan $SOFT_FAIL_ARG dast --command "$ARGS" --container-mode
        cd -
